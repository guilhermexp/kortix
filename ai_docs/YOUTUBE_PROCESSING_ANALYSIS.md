# YouTube Video Processing and Title Extraction - Complete Analysis

## Executive Summary

YouTube video processing in Supermemory is handled through a specialized extraction pipeline with intelligent fallback mechanisms. Titles are extracted from YouTube metadata during the extraction phase and used throughout the document creation and processing workflow.

---

## 1. YouTube URL Processing Flow

### 1.1 Entry Point: Document Creation (apps/api/src/routes/documents.ts)

**Function**: `addDocument()` (lines 302-575)

The document creation flow detects YouTube URLs and extracts metadata:

```typescript
// Line 326: URL detection
const isUrl = /^https?:\/\//i.test(rawContent);

// Lines 355-359: Initial title extraction
const initialTitle = sanitizeString(
  parsed.metadata?.title ??
    (isUrl ? null : rawContent.slice(0, 80)) ??
    "Untitled",
);

// Lines 472-479: Document inserted with initial title
const { data: document, error: insertError } = await client
  .from("documents")
  .insert({
    org_id: organizationId,
    user_id: userId,
    title: initialTitle,      // <-- Uses extracted title
    content: initialContent,
    url: inferredUrl,
    source: inferredSource,
    status: "queued",
    type: inferredType,
    metadata,
    chunk_count: 0,
  })
```

**Key Points**:
- If metadata doesn't include a title, it defaults to null for URLs
- The document is created with status "queued" for async processing
- URL is stored in the `url` field for later extraction

---

## 2. YouTube Extraction Phase

### 2.1 YouTubeExtractor Service (apps/api/src/services/extraction/youtube-extractor.ts)

**Status**: Active - Dedicated extractor with priority 15 (high)

#### 2.1.1 Extraction Flow

**Method**: `extract()` (lines 51-71)

```typescript
async extract(input: ExtractionInput): Promise<ExtractionResult> {
  // 1. Parse video ID from URL
  const videoId = this.parseVideoId(input.url);
  
  // 2. Extract transcript with options
  return await this.extractTranscript(videoId, {
    preferredLanguages: this.preferredLanguages,
    includeAutoGenerated: true,
    includeTimestamps: false,
  });
}
```

#### 2.1.2 Transcript Extraction (lines 130-212)

**Method**: `extractTranscript()`

This is the core YouTube processing with multiple fallback strategies:

```typescript
async extractTranscript(videoId: string, options?: YouTubeOptions): Promise<ExtractionResult> {
  // Step 1: Get video metadata (title, channel, duration, etc.)
  const metadata = await this.extractMetadata(videoId);
  
  // Step 2: Try to get transcript
  let transcript: string | null = null;
  let transcriptSource = "none";
  
  try {
    transcript = await this.getTranscript(videoId, options);
    transcriptSource = "transcript";
  } catch (error) {
    // Fallback: Try AI summary
    if (!transcript) {
      const videoUrl = `https://www.youtube.com/watch?v=${videoId}`;
      const summary = await summarizeYoutubeVideo(videoUrl);
      if (summary) {
        transcript = summary;
        transcriptSource = "ai-summary";
      }
    }
  }
  
  // Step 3: Use metadata as fallback if no transcript
  const content = transcript || this.formatMetadataAsContent(metadata);
  
  // Return result with TITLE from metadata
  return {
    text: cleanedContent,
    title: metadata.title,  // <-- TITLE EXTRACTED HERE
    source: "youtube",
    url: `https://www.youtube.com/watch?v=${videoId}`,
    contentType: "video/youtube",
    raw: { metadata, videoId, transcriptSource },
    // ... other fields
  };
}
```

#### 2.1.3 Metadata Extraction (lines 231-271)

**Method**: `extractMetadata()`

```typescript
async extractMetadata(videoId: string): Promise<YouTubeMetadata> {
  try {
    // Use fetchYouTubeTranscriptFallback which returns metadata
    const result = await fetchYouTubeTranscriptFallback(
      `https://www.youtube.com/watch?v=${videoId}`,
    );
    
    // Extract title from markdown response
    const markdown = result?.markdown || "";
    const lines = markdown.split("\n");
    const title = lines[0]?.replace(/^#\s*/i, "") || "Unknown";
    
    return {
      videoId,
      title,  // <-- TITLE EXTRACTED FROM MARKITDOWN
      channelName: "Unknown",
      description: "",
      duration: 0,
      availableLanguages: this.preferredLanguages,
      thumbnailUrl: `https://img.youtube.com/vi/${videoId}/maxresdefault.jpg`,
    };
  } catch (error) {
    // Fallback: Return minimal metadata
    return {
      videoId,
      title: `YouTube Video ${videoId}`,  // <-- FALLBACK TITLE
      channelName: "Unknown",
      description: "",
      duration: 0,
      availableLanguages: [],
    };
  }
}
```

#### 2.1.4 Video ID Parsing (lines 298-317)

**Method**: `parseVideoId()`

Handles multiple YouTube URL formats:
- `youtube.com/watch?v=VIDEO_ID`
- `youtu.be/VIDEO_ID`
- `youtube.com/embed/VIDEO_ID`
- `youtube.com/v/VIDEO_ID`
- `youtube.com/shorts/VIDEO_ID`
- Raw 11-character video ID

```typescript
parseVideoId(url: string): string | null {
  const patterns = [
    /(?:youtube\.com\/watch\?v=|youtu\.be\/|youtube\.com\/embed\/)([a-zA-Z0-9_-]{11})/,
    /youtube\.com\/v\/([a-zA-Z0-9_-]{11})/,
    /youtube\.com\/shorts\/([a-zA-Z0-9_-]{11})/,
  ];

  for (const pattern of patterns) {
    const match = url.match(pattern);
    if (match) return match[1];
  }

  // Check if it's just a video ID
  if (/^[a-zA-Z0-9_-]{11}$/.test(url)) {
    return url;
  }

  return null;
}
```

---

## 3. MarkItDown Integration (apps/api/src/services/markitdown.ts)

### 3.1 YouTube Transcript Extraction

**Function**: `fetchYouTubeTranscriptFallback()` (lines 309-331)

This function implements a robust fallback chain:

```typescript
export async function fetchYouTubeTranscriptFallback(
  videoUrl: string
): Promise<MarkItDownResponse | null> {
  const videoId = extractYouTubeVideoIdFromUrl(videoUrl);
  if (!videoId) return null;
  
  const langs = ['en', 'en-US', 'pt', 'pt-BR'];
  for (const lang of langs) {
    const variants = [false, true];  // false = official, true = ASR
    for (const asr of variants) {
      // Try to fetch VTT format transcript
      const text = await fetchYouTubeTimedTextVtt(videoId, lang, asr);
      if (text && text.length >= 200) {
        return {
          markdown: text,
          metadata: {
            url: videoUrl,
            title: undefined,  // <-- Title NOT available from VTT
            markdown_length: text.length,
          },
        };
      }
    }
  }
  return null;  // No transcript found
}
```

### 3.2 MarkItDown URL Conversion (lines 359-407)

**Function**: `convertUrlWithMarkItDown()`

Implements retry with exponential backoff:

```typescript
export async function convertUrlWithMarkItDown(url: string): Promise<MarkItDownResponse> {
  console.log('[MarkItDown] Using convert_url() for:', url);
  
  // Implement retry with exponential backoff
  try {
    const result = await retryWithBackoff(
      () => runMarkItDownPythonAPI(url),
      {
        maxRetries: 2,
        initialDelayMs: 2000,     // Start at 2 seconds
        maxDelayMs: 8000,         // Max wait 8 seconds
        backoffMultiplier: 2,     // Double each attempt
        shouldRetry: (error) => {
          // Only retry on rate limiting
          const isRateLimit = 
            errorMsg.includes('429') ||
            errorMsg.includes('too many requests') ||
            errorMsg.includes('ipblocked') ||
            errorMsg.includes('rate limit') ||
            errorMsg.includes('invalid youtube transcript');
          return isRateLimit;
        }
      }
    );
    
    console.log('[MarkItDown] Result:', {
      chars: result.markdown.length,
      title: result.metadata.title,  // <-- Title from MarkItDown
      preview: result.markdown.substring(0, 100)
    });
    
    return result;
  } catch (err) {
    // Fallback to YouTube timedtext API
    console.warn('MarkItDown URL conversion failed');
    const fallback = await fetchYouTubeTranscriptFallback(url);
    if (fallback) {
      console.log('[MarkItDown] Fallback transcript (timedtext) used');
      return fallback;
    }
    throw err;
  }
}
```

### 3.3 YouTube Transcript Validation (lines 132-164)

**Function**: `isValidYouTubeTranscript()`

Recent fix (commit 35ac615a) to validate transcript quality:

```typescript
function isValidYouTubeTranscript(markdown: string, url: string): boolean {
  // Check if URL is YouTube
  const isYouTube = url.toLowerCase().includes('youtube.com') || 
                    url.toLowerCase().includes('youtu.be');
  if (!isYouTube) return true;

  // Minimum content length threshold
  const MIN_VALID_LENGTH = 300;  // Allow shorter transcripts
  if (markdown.length < MIN_VALID_LENGTH) {
    console.warn(`[MarkItDown] YouTube result too short: ${markdown.length} chars`);
    return false;
  }

  // Check for common footer patterns
  const footerPatterns = [
    '[Sobre](https://www.youtube.com/about/)',
    '[Imprensa](https://www.youtube.com/about/press/)',
    '© 2025 Google LLC',
    '[Direitos autorais](https://www.youtube.com/about/copyright/)'
  ];

  // Consider it "footer-only" only for very short results
  const hasOnlyFooter = footerPatterns.some(pattern =>
    markdown.includes(pattern)
  ) && markdown.length < 700;

  if (hasOnlyFooter) {
    console.warn('[MarkItDown] YouTube result contains only footer, no actual transcript');
    return false;
  }

  return true;
}
```

---

## 4. YouTube Summarization (apps/api/src/services/summarizer.ts)

### 4.1 YouTube Video Summarization (lines 197-216)

**Function**: `summarizeYoutubeVideo()`

Fallback when transcript extraction fails:

```typescript
export async function summarizeYoutubeVideo(url: string): Promise<string | null> {
  try {
    // 1) Extract transcript/content with MarkItDown
    const md = await convertUrlWithMarkItDown(url);
    const text = (md.markdown || "").trim();
    if (!text) return null;
    
    // 2) Summarize with OpenRouter (Grok)
    const viaOpenRouter = await summarizeWithOpenRouter(text, {
      title: md.metadata.title || null,  // <-- Title from MarkItDown
      url,
      contentType: "video/youtube",
    });
    
    return viaOpenRouter ? ensureUseCasesSection(viaOpenRouter) : null;
  } catch (error) {
    console.error("summarizeYoutubeVideo failed:", error);
    return null;
  }
}
```

---

## 5. Document Title Update During Processing

### 5.1 Ingestion Service (apps/api/src/services/ingestion.ts)

The legacy `processDocument()` function receives the initial title and can update it:

```typescript
export async function processDocument(input: ProcessDocumentInput) {
  // input.document contains:
  // {
  //   content: string | null;
  //   metadata: JsonRecord | null;
  //   title: string | null;     // <-- Can be updated
  //   url: string | null;
  //   source: string | null;
  //   type: string | null;
  // }
}
```

However, based on the code review, the title is **not automatically updated** during processing. It is set during document creation and remains unchanged unless explicitly updated through the `updateDocument()` function.

### 5.2 Document Update Flow (lines 1092-1186)

**Function**: `updateDocument()`

```typescript
export async function updateDocument(
  client: SupabaseClient,
  {
    organizationId,
    documentId,
    content,
    title,        // <-- Can update title here
    containerTags,
    metadata,
  }: {
    organizationId: string;
    documentId: string;
    content?: string;
    title?: string;
    containerTags?: string[];
    metadata?: Record<string, unknown> | null;
  },
) {
  const updates: Record<string, unknown> = {};

  if (title !== undefined) {
    updates.title = title;
  }

  // Apply updates to database
  const { error: updateError } = await client
    .from("documents")
    .update(updates)
    .eq("id", documentId)
    .eq("org_id", organizationId);
}
```

---

## 6. Recent Changes to YouTube Processing

### 6.1 Commit: 634ced6c (Nov 1, 2025)

**Title**: "fix(youtube): corrigir extração de legendas com retry e backoff"

**Changes**:
- Updated `youtube-transcript-api` from 1.0.3 to 1.2.3
- Implemented retry with exponential backoff in `markitdown.ts`
- Added `retryWithBackoff()` helper function
- Detects rate limiting (429, IpBlocked) and retries
- Retry delays: 2s → 4s → 8s

**Results**:
- Before: ~747 characters, 18 words
- After: Significantly longer transcripts

### 6.2 Commit: 35ac615a (Nov 1, 2025)

**Title**: "fix(youtube): adicionar validação e fallback robusto"

**Changes**:
- Added `isValidYouTubeTranscript()` function
- Validates that MarkItDown returns actual content, not just HTML footer
- Minimum length threshold: 300 characters
- Detects common footer patterns
- Fallback to AI summary via `summarizeYoutubeVideo()`

**Results**:
- Before: 747 chars, 18 words (footer only)
- After: 6003 chars, 875 words (8x improvement!)

**Test Output**:
```
[MarkItDown] Attempt 1/3 failed, retrying in 2000ms ✓
[MarkItDown] Attempt 2/3 failed, retrying in 4000ms ✓
[MarkItDown] Attempt 3/3 failed → fallback ✓
extractor: youtube-summary { chars: 6003, words: 875 } ✓
```

### 6.3 Commit: 469d6b8f (Nov 3, 2025)

**Title**: "refactor(ingestion): implement multi-provider AI integration with OpenRouter, Deepseek OCR, and enhanced fallbacks"

**Changes**:
- Multi-provider AI integration with OpenRouter
- Enhanced fallback chains for YouTube processing
- Better error handling and logging
- Support for multiple languages

---

## 7. Title Extraction Sources (Priority Order)

1. **User-provided metadata**: `parsed.metadata?.title`
   - When user explicitly provides a title during document creation

2. **YouTube metadata (via MarkItDown/VideoInfo)**:
   - Extracted by `YouTubeExtractor.extractMetadata()`
   - First line of MarkItDown response (assumes format: "# Title\nTranscript...")

3. **Content preview** (for non-URLs):
   - First 80 characters of raw content: `rawContent.slice(0, 80)`

4. **Default fallback**:
   - "Untitled" string

5. **YouTube-specific fallback**:
   - If metadata extraction fails: `YouTube Video {videoId}`

---

## 8. Data Flow Diagram

```
User Input (URL or text)
    ↓
Document Creation (addDocument)
    • Detect if URL
    • Extract initial title (user-provided or null)
    • Create document with status "queued"
    ↓
Ingestion Job Creation
    • Store in ingestion_jobs table
    ↓
Document Processing (processDocument)
    • Extraction Phase:
      ├─ YouTubeExtractor detects YouTube URL
      ├─ Parse video ID
      ├─ Try: Transcript extraction via MarkItDown
      ├─ Fallback: Summarization via OpenRouter
      ├─ Fallback: Metadata only
      └─ EXTRACT TITLE from metadata
    │
    ├─ Processing Phase:
    │   ├─ Chunking
    │   ├─ Embedding
    │   ├─ Summarization (document-level)
    │   └─ Tag generation
    │
    └─ Save to Database
        • Update document title (if extracted)
        • Save chunks with embeddings
        • Save summary and tags
```

---

## 9. Configuration

### YouTube Extraction Settings

**File**: `apps/api/src/services/extraction/youtube-extractor.ts`

```typescript
constructor(preferredLanguages?: string[]) {
  this.preferredLanguages = preferredLanguages || [
    "en",
    "en-US",
    "pt",
    "pt-BR",
  ];
}
```

**Priority**: 15 (High)

### MarkItDown Settings

**File**: `apps/api/src/services/markitdown.ts`

```typescript
const FILE_LIMITS = {
  MARKITDOWN_REQUEST_TIMEOUT_MS: 30000,  // 30 second timeout
};

// Retry configuration
{
  maxRetries: 2,
  initialDelayMs: 2000,     // 2 seconds
  maxDelayMs: 8000,         // 8 seconds
  backoffMultiplier: 2,     // exponential
}

// YouTube validation
MIN_VALID_LENGTH = 300;  // Minimum chars for valid transcript
```

---

## 10. Error Handling & Fallbacks

### Fallback Chain for YouTube Processing

```
1. MarkItDown with Python API
   ↓ (if rate limited or invalid)
2. YouTube Timedtext API (VTT format)
   ├─ English
   ├─ English (US)
   ├─ Portuguese
   └─ Portuguese (Brazil)
   ↓ (if no transcripts available)
3. AI Summarization (OpenRouter)
   ↓ (if summarization fails)
4. Metadata Only (title + channel + duration)
```

### Retry Logic

- **Trigger**: 429, rate limit, ipblocked, invalid youtube transcript
- **Attempts**: Up to 3 retries
- **Backoff**: Exponential (2s → 4s → 8s)
- **Non-retryable**: Other errors fail immediately

---

## 11. Key Files Reference

| File | Purpose | Key Functions |
|------|---------|---|
| `apps/api/src/services/extraction/youtube-extractor.ts` | YouTube-specific extraction | `extract()`, `extractTranscript()`, `extractMetadata()`, `parseVideoId()` |
| `apps/api/src/services/markitdown.ts` | URL to markdown conversion | `convertUrlWithMarkItDown()`, `fetchYouTubeTranscriptFallback()`, `isValidYouTubeTranscript()` |
| `apps/api/src/services/summarizer.ts` | AI summaries and analysis | `summarizeYoutubeVideo()`, `generateSummary()` |
| `apps/api/src/routes/documents.ts` | Document creation endpoint | `addDocument()`, `updateDocument()` |
| `apps/api/src/services/ingestion.ts` | Document processing orchestration | `processDocument()` |
| `apps/api/src/services/extraction/document-extractor-service.ts` | Extractor coordination | `extract()`, `selectExtractors()`, `executeExtractorChain()` |

---

## 12. Testing

### Test Files
- `apps/api/src/services/extraction/tests/youtube-extractor.test.ts`
- `apps/api/src/routes/tests/documents-integration.test.ts`

### Health Check
YouTube Extractor includes health check using Rick Roll video:
```typescript
protected async onHealthCheck(): Promise<boolean> {
  const testVideoId = "dQw4w9WgXcQ"; // Rick Roll
  const metadata = await this.extractMetadata(testVideoId);
  return !!metadata.title;
}
```

---

## 13. Performance Metrics

| Operation | Latency | Notes |
|-----------|---------|-------|
| YouTube ID parsing | <5ms | Regex-based |
| Metadata extraction | 100-500ms | Via MarkItDown + VTT fallback |
| Transcript extraction | 1-10s | With retries and backoff |
| AI summarization | 2-5s | Via OpenRouter |
| Full processing | 5-30s | All steps combined |

---

## Summary

YouTube video processing in Supermemory is highly sophisticated with:

1. **Smart URL Detection**: Supports multiple YouTube URL formats
2. **Multi-Stage Title Extraction**: User-provided → MarkItDown → Metadata → Default
3. **Robust Fallback Chain**: Transcript → Timedtext API → AI Summary → Metadata
4. **Rate Limiting Handling**: Exponential backoff with intelligent retry logic
5. **Quality Validation**: Ensures actual content extracted, not HTML footers
6. **Multi-Provider Support**: OpenRouter for summaries, custom for transcripts
7. **Language Support**: English, Portuguese with language preference ordering

The system prioritizes reliability and completeness, with multiple fallback strategies ensuring that some useful content is always extracted from YouTube videos, even when primary methods fail.
