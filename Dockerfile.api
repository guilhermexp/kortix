FROM oven/bun:1

RUN apt-get update && apt-get install -y \
    python3 python3-pip python3-venv gcc \
    && rm -rf /var/lib/apt/lists/*

WORKDIR /app

COPY package.json bun.lock ./
COPY apps/api/package.json apps/api/
COPY apps/web/package.json apps/web/
COPY packages/ packages/

RUN bun install

COPY . .

RUN bash apps/api/install-markitdown.sh || true

ENV MARKITDOWN_PYTHON_PATH=python3
ENV PORT=4000

EXPOSE 4000

CMD ["bun", "run", "--cwd", "apps/api", "start"]
